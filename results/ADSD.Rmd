---
title: "ADSD"
author: "Simon Schwab"
date: "03 May 2018"
output: html_notebook
---

## Install packages
```{r Install packages}
# install.packages("rmarkdown")
# install.packages("testit")
# install.packages("reshape2")
# install.packages("ggplot2")
# install.packages("cowplot")
# install.packages("Hmisc")
# install.packages("nortest")
# install.packages("perm")
# install.packages("lme4")
# install.packages("moments")
# install.packages("circlize")
# install.packages("png")
```

## Load libraries
```{r Load libraries, message=FALSE, warning=TRUE}
library(testit)
library(reshape2)
library(ggplot2)
library(cowplot)
library(Hmisc) # for rcor
library(nortest)
library(lme4)
#library(moments)
#library(perm)
library(grid)
library(circlize)
library(png)
```

## Main variables
```{r Main variables}
N = 62
N_ROIS = 200
PATH_HOME = "/home/simon"
PATH_ROIS200 = file.path(PATH_HOME, 'Drive', 'ADSD_200ROIS_N62')
PATH_ROIS200_GSR = file.path(PATH_HOME, 'Drive', 'ADSD_200ROIS_GSR_N62')
PATH_ROIS200_GSR_AR1 = file.path(PATH_HOME, 'Drive', 'ADSD_200ROIS_GSR_AR1_N62')
PATH = file.path(PATH_HOME, 'Data', 'ADSD')
PATH_FIGS = file.path(PATH, 'figures')
PATH_RES = file.path(PATH, 'results')
```

## Subject infos
```{r Subjects infos}
infos = read.table(file.path(PATH_RES, 'ADSD_info.txt'), header = T)
# Excluded subjects
infos$included = rep(TRUE,N)
# DVARS; more than 20% volumes affected:
infos$included[match("ADSD_13", infos$id)] = FALSE
infos$included[match("ADSD_36", infos$id)] = FALSE
# High E-vars: maybe include
infos$included[match("ADSD_34", infos$id)] = FALSE
# D-Var below 40% ie lots of autocorrelation due to physiology:
infos$included[match("ADSD_15", infos$id)] = FALSE
infos$included[match("ADSD_42", infos$id)] = FALSE
infos$included[match("ADSD_43", infos$id)] = FALSE

infos$included[match("2026", infos$id)] = FALSE # no mri data

infos$isHC = as.logical(infos$isHC)
infos$isAD = as.logical(infos$isAD)
infos$isSD = as.logical(infos$isSD)

infos$group=rep(NA, N)
infos$group[infos$isSD] = 'SD'
infos$group[infos$isAD] = 'AD'
infos$group[infos$isHC] = 'HC'
infos$group = as.factor(infos$group)

assert(nrow(infos) == N)
N_SD  = sum(infos$isSD & infos$included)
N_AD  = sum(infos$isAD & infos$included)
N_HC  = sum(infos$isHC & infos$included)

# DVARS
dvars=read.table(file.path(PATH_RES, 'DVARS.txt'), header = T)
assert(nrow(dvars) == nrow(infos))
infos = cbind(infos, dvars)
rm(dvars)

print(infos)
```

## Exclusions
```{r}
print(infos$id[!infos$included])
summary(infos$group[!infos$included])

# percentage excluded
sum(!infos$included)/N
```


## Demographics
```{r Demographics}
d.demog = data.frame(Group=as.factor(c('SD', 'AD', 'HC')),
                     N_Total=c(sum(infos$isSD), sum(infos$isAD), sum(infos$isHC)),
                     N_included=c(sum(infos$isSD & infos$included),
                                  sum(infos$isAD & infos$included),
                                  sum(infos$isHC & infos$included)),
                     age_mean=round(c(mean(infos$age[infos$isSD & infos$included]),
                                 mean(infos$age[infos$isAD & infos$included]),
                                 mean(infos$age[infos$isHC & infos$included]))),
                     age_sd=round(c(sd(infos$age[infos$isSD & infos$included]),
                                    sd(infos$age[infos$isAD & infos$included]),
                                    sd(infos$age[infos$isHC & infos$included])))
)

print(d.demog)
```

## DVARS analysis
```{r}
a = read.table(file.path(PATH_RES, 'DVARS_vols_affected.txt'), header = F)
b = cbind(rep(0,N), a[,1:ncol(a)-1])
affected = a | b
rm(a); rm(b)

# which subjetc have more than 20% of their volumes affected?
print(as.character(infos$id[rowSums(affected) > infos$N_vols*0.2]))

# lillie.test(infos$SD_SDVARS_X2)
summary(aov(SD_SDVARS_X2 ~ group, data=infos))

# lillie.test(infos$g_Avar)
summary(aov(g_Avar ~ group, data=infos))

# DVARS after excluding subjects
infos_ = subset(infos, included)

summary(aov(SD_SDVARS_X2 ~ group, data=infos_))
summary(aov(g_Avar ~ group, data=infos_))
```
### Plot
```{r, fig.height=2, fig.width=4}
p1 = ggplot(infos, aes(x=group, y=Svar/Dvar)) + geom_boxplot() + 
  coord_cartesian(ylim = c(0.5,2), expand = TRUE) +
  ggtitle(paste("N =", as.character(dim(infos)[1])))

p2 = ggplot(infos_, aes(x=group,y=Svar/Dvar)) + geom_boxplot() + 
  coord_cartesian(ylim = c(0.5,2), expand = TRUE) +
  ggtitle(paste("N =", as.character(dim(infos_)[1])))

plot_grid(p1, p2, ncol = 2, nrow = 1, rel_widths = c(1, 1))
```


### Plot
```{r, fig.height=4, fig.width=4}
set.seed(1980)
p1 = ggplot(infos, aes(x=group, y=SD_SDVARS_X2)) + geom_boxplot() + 
  coord_cartesian(ylim = c(0.8, 2)) +
  geom_point(shape=1, color="gray70", size=2, position = position_jitter(width = 0.2, height = 0.01)) +
  ggtitle("before exclusion")

p2 = ggplot(infos_, aes(x=group, y=SD_SDVARS_X2)) + geom_boxplot() +
  coord_cartesian(ylim = c(0.8, 2)) +
  geom_point(shape=1, color="gray70", size=2, position = position_jitter(width = 0.2, height = 0.01)) + 
  ggtitle("after exclusion")

p3 = ggplot(infos, aes(x=group, y=g_Avar)) + geom_boxplot() +
  geom_point(shape=1, color="gray70", size=2, position = position_jitter(width = 0.2, height = 0.01)) +
  ggtitle("before exclusion")

p4 = ggplot(infos_, aes(x=group, y=g_Avar)) + geom_boxplot() +
  geom_point(shape=1, color="gray70", size=2, position = position_jitter(width = 0.2, height = 0.01)) + 
  ggtitle("after exclusion")

plot_grid(p1, p2, p3, p4, ncol = 2, nrow = 2, rel_widths = c(1, 1))
```


## Global signal regression
```{r, warning=FALSE}
# # first stockholm sample, then china sample
# f1 = list.files(path = PATH_ROIS200, pattern = "^ADSD.*.txt")
# f2 = list.files(path = PATH_ROIS200, pattern = "^20.*.txt")
# f = c(f1,f2)
# rm(f1); rm(f2)
# assert(length(f) == N)
# 
# for (s in 1:N) {
#   d = read.table(file.path(PATH_ROIS200, f[s]), header = F)
#   # acf(d[,50]) # check autocorrelation
#   idx = !affected[s,][1:infos$N_vols[s]]
#   d = as.matrix(d[idx,]) # excluding affected scans
# 
#   # global signal regression
#   d_gs = array(NA, dim=dim(d))
#   gs = apply(d, 1, mean, na.rm=T)
#   for (r in 1:N_ROIS) {
#     if (sum(is.na(d[,r])) == length(gs)) {
#       d_gs[,r] = rep(NA, length(gs))
#     } else {
#       fit = lm(d[,r] ~ gs)
#       d_gs[,r] = fit$residuals
#     }
#   }
# 
#   # save gs time series
#   write(t(d_gs), file=file.path(PATH_ROIS200_GSR, f[s]), ncolumns = N_ROIS)
# }
```

## Load time series
```{r warning=FALSE}
# # first stockholm sample, then china sample
# f1 = list.files(path = PATH_ROIS200, pattern = "^ADSD.*.txt")
# f2 = list.files(path = PATH_ROIS200, pattern = "^20.*.txt")
# f = c(f1,f2)
# rm(f1); rm(f2)
# assert(length(f) == N)
# 
# R     = array(NA, dim=c(N_ROIS, N_ROIS, N))
# R_gsr = array(NA, dim=c(N_ROIS, N_ROIS, N))
# R_ar1 = array(NA, dim=c(N_ROIS, N_ROIS, N))
# 
# ts_    = list()
# ts_gsr = list()
# 
# for (s in 1:N) {
#   print(s)
#   d = as.matrix(read.table(file.path(PATH_ROIS200, f[s]), header = F))
#   #acf(d[,50]) # check autocorrelation
#   ts_[[s]] = d
#   tmp =  rcorr(d, type="pearson")
#   R[,,s] = tmp$r
# 
#   d = as.matrix(read.table(file.path(PATH_ROIS200_GSR, f[s]), header = F))
#   ts_gsr[[s]] = d
#   tmp =  rcorr(d, type="pearson")
#   R_gsr[,,s] = tmp$r
# 
#   d = as.matrix(read.table(file.path(PATH_ROIS200_GSR_AR1, f[s]), header = F))
#   tmp =  rcorr(d, type="pearson")
#   R_ar1[,,s] = tmp$r
# }
# save(R, R_gsr, R_ar1, ts_, ts_gsr, file = file.path(PATH_RES, 'ADSD.RData'))
# 
load(file.path(PATH_RES, 'ADSD.RData'))
```

Subjects excluded
```{r}
print(subset(infos, !infos$included))
```

## Load ROIs of temporal regions
```{r Load ROIs}
rois=as.matrix(read.table(file.path(PATH_RES, 'Cradd_tmp_labels.txt'), header = F))
rois=rois[1,]
Nn = length(rois)
```

## Looking at mean variance across nodes
```{r}
node.var = rep(NA, N)

for (s in 1:N) {
  node.var[s] = mean(apply(ts_[[s]][,rois], 2, sd), na.rm=T)
}

infos$node.var = node.var
infos$large.var = node.var > 1
```

Subjects included with large node variance
```{r}
print(subset(infos, infos$large.var & infos$included))
```

## Plot time series
* First two subjects have lowest framewise displacement (01 and 2001)
* Next 6 subjects have been excluded based on DVARS
* Last 5 subejcts are "worst" subjects in terms of node variance that are included
```{r fig.height=20, fig.width=16}
idx = 1:200 # interval to plot
set.seed(1980)
nodes = sample(rois, 5) # selection of nodes to plot
#n = sample(which(infos$included), 10) # selection of subjects to plot
n = c(1, 45, which(!infos$included), which(infos$large.var & infos$included))

p = list()

for (s in 1:length(n)) {
  x = ts_[[n[s]]][,nodes]
  offset = t(array(rep(seq(-4,4,2),nrow(x)), dim=c(5,nrow(x))))
  p[[s]] = ggplot(melt(x+offset), aes(x = Var1, y = value, group=Var2, color=Var2)) + geom_line() + theme_minimal() +
    ggtitle(sprintf('%s',infos$id[n[s]])) + ylim(c(-7, 7))
  
  
  x = ts_gsr[[n[s]]][,nodes]
  offset = t(array(rep(seq(-4,4,2),nrow(x)), dim=c(5,nrow(x))))
  p[[s+length(n)]] = ggplot(melt(x+offset), aes(x = Var1, y = value, group=Var2, color=Var2)) + geom_line() + theme_minimal() +
    ggtitle(sprintf('%s',infos$id[n[s]])) + ylim(c(-7, 7))
}

# resorting plots
a=1:(length(n)*2)
x=c(t(matrix(t(a), length(n), 2)))

plot_grid(plotlist = p[x], ncol = 2, nrow = 14, rel_widths = c(1, 1), 
          labels = c("Without global signal regressionm (GRS)", "                            with GRS"))
```

## Compare distributions of Pearson's r
```{r}
g = c(rep('SD', N_ROIS*N_ROIS*sum(infos$isSD)),
      rep('AD', N_ROIS*N_ROIS*sum(infos$isAD)),
      rep('HC', N_ROIS*N_ROIS*sum(infos$isHC))
)

Rd = data.frame(R = c(c(R[,,infos$isSD]), c(R[,,infos$isAD]), c(R[,,infos$isHC])), group = g)
Rd$group = factor(Rd$group, levels = c("HC", "SD", "AD"))

Rd_gsr = data.frame(R = c(c(R_gsr[,,infos$isSD]), c(R_gsr[,,infos$isAD]), c(R_gsr[,,infos$isHC])), group = g)
Rd_gsr$group = factor(Rd_gsr$group, levels = c("AD", "HC", "SD"))

Rd_ar1 = data.frame(R = c(c(R_ar1[,,infos$isSD]), c(R_ar1[,,infos$isAD]), c(R_ar1[,,infos$isHC])), group = g)
Rd_ar1$group = factor(Rd_ar1$group, levels = c("AD", "HC", "SD"))

s = c(rep('Sweden', N_ROIS*N_ROIS*sum(infos$site==1)),
      rep('China',  N_ROIS*N_ROIS*sum(infos$site==2))
)

Rd_site = data.frame(R = c(c(R_ar1[,,infos$site==1]), c(R_ar1[,,infos$site==2])), site = s)
Rd_site$site = factor(Rd_site$site, levels = c("Sweden", "China"))

M = array(c(
  mean(R_ar1[,,infos$isSD], na.rm = T), mean(R_ar1[,,infos$isAD], na.rm = T), mean(R_ar1[,,infos$isHC], na.rm = T),
  sd(R_ar1[,,infos$isSD], na.rm = T), sd(R_ar1[,,infos$isAD], na.rm = T), sd(R_ar1[,,infos$isHC], na.rm = T)),
  dim=c(3,2)
  )

colnames(M)  = c("mean", "SD")
rownames(M) = c("SD", "AD", "HC")
print(M)
```

### Density plots
```{r fig.height=5, fig.width=7, message=FALSE, warning=FALSE}
# p1 = ggplot(Rd,     aes(x=R, fill=group)) + geom_histogram(alpha=0.3, position="identity", binwidth = 0.05) +
#   ggtitle("raw") + coord_cartesian(ylim = c(0, 10^5)) 
# p2 = ggplot(Rd_gsr, aes(x=R, fill=group)) + geom_histogram(alpha=0.3, position="identity", binwidth = 0.05) +
#   ggtitle("GSR")
# p3 = ggplot(Rd_ar1, aes(x=R, fill=group)) + geom_histogram(alpha=0.3, position="identity", binwidth = 0.05) +
#   ggtitle("AR1")
# p4 = ggplot(Rd_site, aes(x=R, fill=site)) + geom_histogram(alpha=0.3, position="identity", binwidth = 0.05) +
#   ggtitle("AR1")

p1 = ggplot(Rd,      aes(x=R, fill=group)) + geom_density(alpha=0.5) + ggtitle("raw")
p2 = ggplot(Rd_gsr,  aes(x=R, fill=group)) + geom_density(alpha=0.5) + ggtitle("GSR")
p3 = ggplot(Rd_ar1,  aes(x=R, fill=group)) + geom_density(alpha=0.5) + ggtitle("GSR + AR1")
#p4 = ggplot(Rd_site, aes(x=R, fill=site))  + geom_density(alpha=0.3) + ggtitle("AR1")

plot_grid(p1, p2, p3, ncol = 2, nrow = 2)
```

## Fisher z-transformation
```{r}
Z = 0.5*(log(1+R_gsr) - log(1-R_gsr))
# Z = 0.5*(log(1+R_ar1) - log(1-R_ar1))
# Z = 0.5*log((1+R_ar1)/(1-R_ar1))
# Z = atanh(R_ar1)
```

## Voxel-wise ANOVA
```{r}
set.seed(1980)
anova=list()
anova$groupFvals = array(NA, dim=c(Nn, Nn))
anova$groupPvals = array(NA, dim=c(Nn, Nn))
anova$ageFvals = array(NA, dim=c(Nn, Nn))
anova$agePvals = array(NA, dim=c(Nn, Nn))

anova$perm.Pvals = array(NA, dim=c(Nn, Nn))
anova$perm.Stats = array(NA, dim=c(Nn, Nn))

for (i in 1:Nn) {
  #print(i)
  for (j in 1:Nn) {
    if (i > j) {
      y = Z[rois[i], rois[j], ]
      idx = infos$included
      # fit = aov(y[idx] ~ infos$group[idx]) # df=2/52
      fit = aov(y[idx] ~ infos$group[idx] + infos$age[idx]) # df=2/52
      # qqnorm(resid(fit))
      # qqline(resid(fit), col="red")
      result = summary(fit)

      anova$groupFvals[i,j] = result[[1]]$`F value`[1]
      anova$groupPvals[i,j] = result[[1]]$`Pr(>F)`[1]

      anova$ageFvals[i,j] = result[[1]]$`F value`[2]
      anova$ageFvals[i,j] = result[[1]]$`Pr(>F)`[2]

      # result2 = permKS(y[idx] ~ infos$group[idx])
      # anova$perm.Stats[i, j] = result2$statistic # df = 2
      # anova$perm.Pvals[i, j] = result2$p.value
    }
  }
}

save(anova, file = file.path(PATH_RES, 'anova.RData'))
```

## FDR correction
```{r}
load(file.path(PATH_RES, 'anova.RData'))

x=array(NA, dim=c(1,2))
x[1] = sum(anova$groupPvals < 0.05, na.rm = T)
anova$groupPvalsFDR = array(p.adjust(anova$groupPvals, method = "fdr"), dim=c(Nn, Nn))
x[2] = sum(anova$groupPvalsFDR < 0.05, na.rm = T)
colnames(x) = c("No. of sign. edges", "No. of sign. edges (FDR adjusted)")
print(x)

anova$perm.PvalsFDR = array(p.adjust(anova$perm.Pvals, method = "fdr"), dim=c(Nn, Nn))
# sum(anova$perm.PvalsFDR < 0.10, na.rm = T)
```

## Significant edges (Craddock ROI number)
```{r}
idx = which(anova$groupPvalsFDR < 0.05, arr.ind = T)
edges = array(rois[idx], dim=c(nrow(idx),2))
print(edges)
unique(sort(edges))
```

### Sorted 
```{r}
unique(sort(edges))
```


## Result Table
```{r}
roiLables = read.table(file.path(PATH_RES, 'Cradd_additional_labels.txt'), header = T)
resultsTable = array(NA, dim=c(nrow(edges), 8))

resultsTable[,1:2] = edges
resultsTable[,3:4] = array(roiLables$label[match(edges, roiLables$roinr)], dim=c(nrow(edges),2))
resultsTable[,5] = round(anova$groupFvals[idx], digits = 2)
resultsTable[,6] = round(anova$groupPvalsFDR[idx], digits = 4)
resultsTable[,7:8] = array(roiLables$abbrev2[match(edges, roiLables$roinr)], dim=c(nrow(edges),2))
colnames(resultsTable) = c("ROI", "ROI", "Region", "Region", "F-value", "adj. p-value", "Abb.", "Abb.")

# order table based on significance
ord = order(anova$groupFvals[idx], decreasing = T)
print(resultsTable[ord,])
```

## Post-hoc tests
```{r}
table_posthoc = array(NA, dim=c(3, nrow(edges)))

for (i in 1:nrow(edges)) {
  y = Z[edges[i,][1], edges[i,][2], infos$included]
  d = data.frame(Z=y, group=infos$group[infos$included])
  fit = aov(Z ~ group, data = d)
  res=TukeyHSD(fit)
  table_posthoc[,i] = res$group[,4]
}
colnames(table_posthoc) = 1:nrow(edges)
rownames(table_posthoc) = c("HC-AD", "SD-AD", "SD-HC")
print(round(table_posthoc, digits = 3))
```set.see

Number of significant edges per group contrast
```{r}
apply(table_posthoc < 0.05, 1, sum)
```

## Plot Z scores
```{r fig.height=4, fig.width=6.5, message=FALSE, warning=FALSE}
set.seed(1980)
p = list()
line=data.frame(yintercept=0, cutoff=factor(0))

scaleFUN <- function(x) sprintf("%.1f", x)

for (i in 1:nrow(edges)) {
  x = Z[edges[i,][1],edges[i,][2],]
  d = data.frame(Z = x[infos$included], group=infos$group[infos$included])
  d$group = factor(d$group, c("SD", "AD", "HC"))
  p[[i]]= ggplot(d, aes(x=group, y=Z, color=group)) + geom_boxplot(width=0.7) +
    geom_point(shape=1, color="gray60", size=1.5, position = position_jitter(width = 0.2, height = 0)) + 
    coord_cartesian(ylim = c(-0.8, 1.5)) +
    #geom_hline(aes(yintercept=0), colour="#990000", linetype="dashed") +
    scale_y_continuous(labels=scaleFUN) +
    theme(axis.text = element_text(size=10), plot.title = element_text(size=9, face = "plain"), 
          legend.position="none", axis.title.x=element_blank(),
          panel.grid.major = element_line(size = 0.4, linetype = "dashed" , colour = "gray70")) + 
    #ggtitle(sprintf('%d<->%d', edges[i,1], edges[i,2]))
    
    # display significances
    ggtitle(sprintf('edge no. %d\n %s \U2194 %s', i, resultsTable[i, 7], resultsTable[i, 8]))
    
   
  if (table_posthoc[1,i] < .05) {
    p[[i]] = p[[i]] + geom_segment(aes(x = 2, y = 1.6, xend = 3, yend = 1.6), col = "red", size = 0.3)
    }
  if (table_posthoc[2,i] < .05) {
    p[[i]] = p[[i]] + geom_segment(aes(x = 1, y = 1.5, xend = 2, yend = 1.5), col = "red", size = 0.3)
  } 
  if (table_posthoc[3,i] < .05) {
    p[[i]] = p[[i]] + geom_segment(aes(x = 1, y = 1.4, xend = 3, yend = 1.4), col = "red", size = 0.3)
  }
}

plot_grid(plotlist = p, ncol = 4, nrow = 2) #labels = c("1", "2", "3", "4", "5", "6", "7"))
ggsave(path = PATH_FIGS, "Z-plot.png")
```


### Percentage of neg. correlations across 7 sign. edges and subjects
```{r}
negPrc = array(NA, dim=c(1,3))

Zn = array(NA, dim=c(sum(infos$included), nrow(edges)))
Rn = array(NA, dim=c(sum(infos$included), nrow(edges)))
Rn_gsr = array(NA, dim=c(sum(infos$included), nrow(edges)))
for (i in 1:nrow(edges)) {
  Zn[,i] = Z[edges[i,][1], edges[i,][2], infos$included]
  Rn_gsr[,i] = R_gsr[edges[i,][1], edges[i,][2], infos$included]
  Rn[,i] = R[edges[i,][1], edges[i,][2], infos$included]
  }

negPrc[1] = sum(Zn < 0, na.rm = T) / (sum(infos$included)*nrow(edges))
negPrc[2] = sum(Rn_gsr < 0, na.rm = T) / (sum(infos$included)*nrow(edges))
negPrc[3] = sum(Rn < 0, na.rm = T) / (sum(infos$included)*nrow(edges))
colnames(negPrc) = c("Z", "R with GSR", "R")
print(negPrc)
```

## Plot FC as chord diagram

### Preparing data structures
```{r}
# mask for the sign. edges
mask = array(0, dim=c(N_ROIS, N_ROIS))
mask[edges]=1

# we do not use Z values for the chord diagram because these can be negative
M_SD = apply(R_gsr[,,infos$isSD & infos$included], c(1,2), mean, na.rm=TRUE)
M_SD[!mask]=NA

M_AD = apply(R_gsr[,,infos$isAD & infos$included], c(1,2), mean, na.rm=TRUE)
M_AD[!mask]=NA

M_HC = apply(R_gsr[,,infos$isHC & infos$included], c(1,2), mean, na.rm=TRUE)
M_HC[!mask]=NA

# insert row/column labels to 200x200 matrix and order array to separate left and right nodes
mylabs = as.character(1:200)
mylabs[roiLables[,1]] = as.character(roiLables[,4])
ind=order(mylabs)
mylabs=mylabs[ind]

M_SD_ = M_SD[ind,ind]
M_AD_ = M_AD[ind,ind]
M_HC_ = M_HC[ind,ind]

rownames(M_SD_) = mylabs
colnames(M_SD_) = mylabs

rownames(M_AD_) = mylabs
colnames(M_AD_) = mylabs

rownames(M_HC_) = mylabs
colnames(M_HC_) = mylabs
```

### Show mean connection strengths
```{r}
x=rbind(M_SD[edges], M_AD[edges], M_HC[edges])
rownames(x) = c("SD", "AD","HC")
print(x)
```

### Scaling to make chord diagrams comparable between groups
If not taken care of, link strenghts are relative values.

See http://zuguang.de/circlize_book/book/advanced-usage-of-chorddiagram.html#compare-two-chord-diagrams
```{r}
# calculate percentage difference in connectivity strenght

# check edges and associated no. of gaps and set accordingly.
# length(unique(c(edges)))-2 # total between gaps minus two big gaps
top.gaps   = 5
bottom.gaps= 6

small.gap = 2
big.gap = 10
gap.after = c(rep(small.gap, bottom.gaps), big.gap, rep(small.gap, top.gaps), big.gap)

# scaling factors p
p1=sum(abs(M_SD), na.rm = T) / sum(abs(M_HC), na.rm = T)
p2=sum(abs(M_AD), na.rm = T) / sum(abs(M_HC), na.rm = T)

#      sector   gaps  big gap (2) small gaps (11)  (counts)
# HC   285       75      10           5            degree
# SD   156      204      74           5
# AD   260      100      22           5

# calculate total blank degree and big gap degree
blank.deg = sum(gap.after)
blank.deg1 = 360-(360 - blank.deg)*p1
blank.deg2 = 360-(360 - blank.deg)*p2

gap1 = blank.deg1/length(gap.after)
gap2 = blank.deg2/length(gap.after)

#gap.after1 = rep(gap1, length(gap.after))
#gap.after2 = rep(gap2, length(gap.after))

big.gap1 = (blank.deg1 - small.gap*(bottom.gaps+top.gaps))/2
big.gap2 = (blank.deg2 - small.gap*(bottom.gaps+top.gaps))/2

gap.after1 = c(rep(small.gap, bottom.gaps), big.gap1, rep(small.gap, top.gaps), big.gap1)
gap.after2 = c(rep(small.gap, bottom.gaps), big.gap2, rep(small.gap, top.gaps), big.gap2)
```

### Create colormap
```{r}
#set.seed(1980)
# global colormaps
col_map = colorRamp2(c(-0.4, 0, 0.4), c("blue", "white", "red"), transparency = 0.3)
```

### chord diagram
```{r fig.height=6, fig.width=6}
# save figure
png(filename=file.path(PATH_FIGS, 'network.png'), width=8, height=8, units = 'in', res=300)

par(mfrow=c(2,2), "mar"=c(0, 0, 1, 0))
# all 200 x 200 rois, then apply mask

set.seed(1980)
circos.par(gap.after = gap.after1, start.degree = -big.gap1/2-90)
chordDiagram(M_SD_, directional = FALSE, transparency = 0.5,  annotationTrack = "grid",
             preAllocateTracks = 1, col = col_map, link.lwd = 0.5, link.lty = 1, link.border = "gray")
circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) {
  xlim = get.cell.meta.data("xlim")
  ylim = get.cell.meta.data("ylim")
  sector.name = get.cell.meta.data("sector.index")
  circos.text(mean(xlim), ylim[1] + .1, sector.name, facing = "clockwise", adj = c(0.1,0.5),
              niceFacing = TRUE, col = "black", cex = 0.9)
}, bg.border = NA)
circos.clear()
title("Semantic dementia (SD)", cex.main=1.5, font.main=1)

set.seed(1980)
circos.par(gap.after = gap.after2, start.degree = -big.gap2/2-90)
chordDiagram(M_AD_, directional = F, transparency = 0.5,  annotationTrack = "grid",
             preAllocateTracks = 1, col = col_map, link.lwd = 0.5, link.lty = 1, link.border = "gray")
circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) {
  xlim = get.cell.meta.data("xlim")
  ylim = get.cell.meta.data("ylim")
  sector.name = get.cell.meta.data("sector.index")
  circos.text(mean(xlim), ylim[1] + .1, sector.name, facing = "clockwise", adj = c(0.1,0.5),
              niceFacing = TRUE, col = "black", cex = 0.9)
}, bg.border = NA)
circos.clear()
title("Alzheimer's disease (AD)", cex.main=1.5, font.main=1)

set.seed(1980)
circos.par(gap.after = gap.after, start.degree = -big.gap/2-90)
chordDiagram(M_HC_, directional = F, transparency = 0.5,  annotationTrack = "grid",
             preAllocateTracks = 1, col = col_map, link.lwd = 0.5, link.lty = 1, link.border = "gray")
circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) {
  xlim = get.cell.meta.data("xlim")
  ylim = get.cell.meta.data("ylim")
  sector.name = get.cell.meta.data("sector.index")
  circos.text(mean(xlim), ylim[1] + .1, sector.name, facing = "clockwise", adj = c(0.1,0.5),
              niceFacing = TRUE, col = "black", cex = 0.9)
}, bg.border = NA)
text(0.4,0.3,"3")
text(0.1,0.4,"6")
text(-0.2,0.4,"1")
text(-0.02,0,"2")
text(-0.45,0.3,"4")
text(-0.55,-0.05,"5")
text(-0.5,-0.2,"7")

circos.clear()
title("Healthy elderly controls (HC)", cex.main=1.5, font.main=1)

dev.off() 

img <- readPNG(file.path(PATH_FIGS, "network.png"))
grid.raster(img)
```
Show in New WindowClear OutputExpand/Collapse Output
[1] 0.1601138
[1] -0.06550519
[1] 0.01263284
Show in New WindowClear OutputExpand/Collapse Output
[1] 0.1601138
[1] -0.06550519
[1] 0.01263284


### Minimal example for Chord Diagram
```{r eval=FALSE, include=FALSE}
set.seed(1980)
m = matrix(0, 4, 4)
m[1,2] = 0.5
m[2,4] = -0.08
m[2,3] = 0.10
rownames(m) = 1:4
colnames(m) = 1:4

chordDiagram(m, directional = TRUE, transparency = 0.5)
```
