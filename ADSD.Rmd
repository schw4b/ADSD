---
title: "ADSD"
author: "Simon Schwab"
date: "24 May 2017"
output: html_document
---

## Install packages
```{r Install packages}
# install.packages("rmarkdown")
# install.packages("testit")
# install.packages("Hmisc")
# install.packages("nortest")
# install.packages("multdyn")
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load libraries
```{r Load libraries, message=FALSE, warning=TRUE}
library(testit)
library(reshape2)
library(ggplot2)
library(cowplot)
library(Hmisc)
library(nortest)
library(multdyn)
```

## Main variables
```{r Main variables}
N = 62
N_ROIS = c(14, 200)
PATH_HOME = "/home/simon"
PATH_ROIS = file.path(PATH_HOME, 'Drive', '14RoisN62')
PATH_ROIS200 = file.path(PATH_HOME, 'Drive', '200RoisN62')
PATH = file.path(PATH_HOME, 'workspace', 'ADSD-nbook')
```

## Subject infos
```{r Subjects infos}
infos = read.table(file.path(PATH, 'ADSD_info.txt'), header = T)
rois = read.table(file.path(PATH, 'ROIs_14.txt'), header = T)
# Excluded subjects
infos$included = rep(TRUE,N)
# DVARS; more than 20% volumes affected:
infos$included[match("ADSD_13", infos$id)] = FALSE
infos$included[match("ADSD_36", infos$id)] = FALSE
# High E-vars:
infos$included[match("ADSD_34", infos$id)] = FALSE
# DVARS below 40%:
infos$included[match("ADSD_15", infos$id)] = FALSE
infos$included[match("ADSD_42", infos$id)] = FALSE
infos$included[match("ADSD_43", infos$id)] = FALSE

infos$included[match("2026", infos$id)] = FALSE # no mri data

infos$isHC = as.logical(infos$isHC)
infos$isAD = as.logical(infos$isAD)
infos$isSD = as.logical(infos$isSD)

infos$group=rep(NA,N)
infos$group[infos$isSD] = 'SD'
infos$group[infos$isAD] = 'AD'
infos$group[infos$isHC] = 'HC'
infos$group = as.factor(infos$group)

assert(nrow(infos) == N)
N_SD  = sum(infos$isSD)
N_AD  = sum(infos$isAD)
N_HC  = sum(infos$isHC)
assert(N_SD + N_AD + N_HC == N)

# DVARS
dvars=read.table(file.path(PATH, 'DVARS.txt'), header = T)
assert(nrow(dvars) == nrow(infos))
infos = cbind(infos, dvars)
rm(dvars)

print(infos)
```
## Demographics
```{r Demographics}
d.demog = data.frame(Group=as.factor(c('SD', 'AD', 'HC')),
                     N_Total=c(sum(infos$isSD), sum(infos$isAD), sum(infos$isHC)),
                     N_included=c(sum(infos$isSD & infos$included), sum(infos$isAD & infos$included),
                                  sum(infos$isHC & infos$included)),
                     age_mean=round(c(mean(infos$age[infos$isSD & infos$included]),
                                 mean(infos$age[infos$isAD & infos$included]),
                                 mean(infos$age[infos$isHC & infos$included]))),
                     age_sd=round(c(sd(infos$age[infos$isSD & infos$included]),
                                    sd(infos$age[infos$isAD & infos$included]),
                                    sd(infos$age[infos$isHC & infos$included])))
)

print(d.demog)
```

## ROI labels
Time series are extracted using the k=200 Craddock atlas with a selection of ROIS most prominently overlapping with tempral AAL regions. `AAL_Nr` indicates atlas label, `position` indicates position in matrices from figures and plots. In these, first uneven (left), then even (right) regions are shown.

```{r ROI labels}
rois$position = c(t(array(c(1:N_ROIS[1]), dim=c(7,2))))
print(rois)

# reorder ROIS, first left (uneven) then right (even) rois
reidx=c(seq(1,N_ROIS[1],2), seq(2,N_ROIS[1],2))

# lower diagonal
tri = lower.tri(array(0, dim=c(N_ROIS[1], N_ROIS[1])))
```

## DVARS analysis
```{r DVARS analysis, fig.height=4, fig.width=4}
a = read.table(file.path(PATH, 'DVARS_vols_affected.txt'), header = F)
b = cbind(rep(0,N), a[,1:ncol(a)-1])
affected = a | b
rm(a); rm(b)

# which subjetc have more than 20% of their volumes affected?
print(as.character(infos$id[rowSums(affected) > infos$N_vols*0.2]))

lillie.test(infos$SD_SDVARS_X2)
summary(aov(SD_SDVARS_X2 ~ group, data=infos))

lillie.test(infos$g_Avar)
summary(aov(g_Avar ~ group, data=infos))

# DVARS after excluding subjects
infos_ = subset(infos, included)
summary(aov(SD_SDVARS_X2 ~ group, data=infos_))
summary(aov(g_Avar ~ group, data=infos_))

p1 = ggplot(infos, aes(x=group, y=SD_SDVARS_X2)) + geom_violin() + geom_boxplot(width=0.4) + ylim(c(0.5,2)) +
  geom_point(shape=1, color="gray70", size=4, position = position_jitter(width = 0.2, height = 0.0002))

p2 = ggplot(infos_, aes(x=group, y=SD_SDVARS_X2)) + geom_violin() + geom_boxplot(width=0.4) + ylim(c(0.5,2)) +
  geom_point(shape=1, color="gray70", size=4, position = position_jitter(width = 0.2, height = 0.0002)) + 
  ggtitle("after exclusion")

p3 = ggplot(infos, aes(x=group, y=g_Avar)) + geom_violin() + geom_boxplot(width=0.4) +
  geom_point(shape=1, color="gray70", size=4, position = position_jitter(width = 0.2, height = 0.0002))

p4 = ggplot(infos_, aes(x=group, y=g_Avar)) + geom_violin() + geom_boxplot(width=0.4) +
  geom_point(shape=1, color="gray70", size=4, position = position_jitter(width = 0.2, height = 0.0002)) + 
  ggtitle("after exclusion")

plot_grid(p1, p2, p3, p4, ncol = 2, nrow = 2, rel_widths = c(1, 1))
```

## Load time series of 14 ROIs
```{r Load time series of 14 ROIs, warning=FALSE}
# first stockholm sample, then china sample
f1 = list.files(path = PATH_ROIS, pattern = "^ADSD.*.txt")
f2 = list.files(path = PATH_ROIS, pattern = "^20.*.txt")
f = c(f1,f2)
rm(f1); rm(f2)
assert(length(f) == N)

R = array(NA, dim=c(N_ROIS[1], N_ROIS[1], N))
P = array(NA, dim=c(N_ROIS[1], N_ROIS[1], N))
for (s in 1:N) {
  d = read.table(file.path(PATH_ROIS, f[s]), header = F)
  # R[,,s] = cor(d)
  idx = !affected[s,][1:infos$N_vols[s]] # excluding affected scans
  tmp =  rcorr(as.matrix(d[idx,]), type="pearson")
  
  R[,,s] = tmp$r
  P[,,s] = tmp$P
}
# ADSD_13 has no time series from ROI 11 and ROI 12
```


## Mean correlation per group
```{r Mean correlation per group}
# Correlation R
FC = list()
FC$R$SD = apply(R[,,infos$isSD & infos$included], c(1,2), mean)
FC$R$AD = apply(R[,,infos$isAD & infos$included], c(1,2), mean, na.rm=T) # problem with ADSD_13
FC$R$HC = apply(R[,,infos$isHC & infos$included], c(1,2), mean)

# P values
FC$P$SD = apply(P[,,infos$isSD & infos$included], c(1,2), mean)
FC$P$AD = apply(P[,,infos$isAD & infos$included], c(1,2), mean, na.rm=T) # problem with ADSD_13
FC$P$HC = apply(P[,,infos$isHC & infos$included], c(1,2), mean)

# FDR 0.05
tmp = rbind(FC$P$SD, FC$P$AD, FC$P$HC)
tmp[!rbind(tri,tri,tri)]=NA

# Global FDR across groups
M = array(p.adjust(tmp, method = "fdr"), dim=c(3*N_ROIS[1], N_ROIS[1]))

FC$R_FDR05$SD = FC$R$SD
FC$R_FDR05$AD = FC$R$AD
FC$R_FDR05$HC = FC$R$HC

FC$P_FDR05$SD = M[1:14,]
FC$P_FDR05$AD = M[15:28,]
FC$P_FDR05$HC = M[29:42,]

FC$R_FDR05$SD[FC$P_FDR05$SD >= 0.05 | is.na(FC$P_FDR05$AD)] = 0
FC$R_FDR05$AD[FC$P_FDR05$AD >= 0.05 | is.na(FC$P_FDR05$AD)] = 0
FC$R_FDR05$HC[FC$P_FDR05$HC >= 0.05 | is.na(FC$P_FDR05$HC)] = 0
```

## Plot: FC
```{r Plot: FC, fig.height=4.5, fig.width=9}
limR = c(0, 0.7)

p1 = ggplot(melt(FC$R$SD[reidx,reidx]*tri), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60") +
  scale_fill_gradient2(low  = "blue", mid  = "white", high = "red",
                       midpoint = 0, limit = limR, space = "Lab", name = "R") +
  theme(axis.ticks = element_blank(), axis.line = element_blank(),
        text = element_text(size=12), plot.title = element_text(size=12),
        axis.text.x = element_text(size=12,angle=0),
        axis.text.y = element_text(size=12)) + 
  scale_y_reverse() + ggtitle("SD")

p2 = ggplot(melt(FC$R$AD[reidx,reidx]*tri), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60") +
  scale_fill_gradient2(low  = "blue", mid  = "white", high = "red",
                       midpoint = 0, limit = limR, space = "Lab", name = "R") +
  theme(axis.ticks = element_blank(), axis.line = element_blank(),
        text = element_text(size=12), plot.title = element_text(size=12),
        axis.text.x = element_text(size=12,angle=0),
        axis.text.y = element_text(size=12)) + 
  scale_y_reverse() + ggtitle("AD")

p3 = ggplot(melt(FC$R$HC[reidx,reidx]*tri), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60") +
  scale_fill_gradient2(low  = "blue", mid  = "white", high = "red",
                       midpoint = 0, limit = limR, space = "Lab", name = "R") +
  theme(axis.ticks = element_blank(), axis.line = element_blank(),
        text = element_text(size=12), plot.title = element_text(size=12),
        axis.text.x = element_text(size=12,angle=0),
        axis.text.y = element_text(size=12)) + 
  scale_y_reverse() + ggtitle("HC")

p4 = ggplot(melt(FC$R_FDR05$SD[reidx,reidx]*tri), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60") +
  scale_fill_gradient2(low  = "blue", mid  = "white", high = "red",
                       midpoint = 0, limit = limR, space = "Lab", name = "R") +
  theme(axis.ticks = element_blank(), axis.line = element_blank(),
        text = element_text(size=12), plot.title = element_text(size=12),
        axis.text.x = element_text(size=12,angle=0),
        axis.text.y = element_text(size=12)) + 
  scale_y_reverse() + ggtitle("FDR 0.05")

p5 = ggplot(melt(FC$R_FDR05$AD[reidx,reidx]*tri), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60") +
  scale_fill_gradient2(low  = "blue", mid  = "white", high = "red",
                       midpoint = 0, limit = limR, space = "Lab", name = "R") +
  theme(axis.ticks = element_blank(), axis.line = element_blank(),
        text = element_text(size=12), plot.title = element_text(size=12),
        axis.text.x = element_text(size=12,angle=0),
        axis.text.y = element_text(size=12)) + 
  scale_y_reverse() + ggtitle("FDR 0.05")

p6 = ggplot(melt(FC$R_FDR05$HC[reidx,reidx]*tri), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60") +
  scale_fill_gradient2(low  = "blue", mid  = "white", high = "red",
                       midpoint = 0, limit = limR, space = "Lab", name = "R") +
  theme(axis.ticks = element_blank(), axis.line = element_blank(),
        text = element_text(size=12), plot.title = element_text(size=12),
        axis.text.x = element_text(size=12,angle=0),
        axis.text.y = element_text(size=12)) + 
  scale_y_reverse() + ggtitle("FDR 0.05")

plot_grid(p1, p2, p3, p4, p5, p6, ncol = 3, nrow = 2, rel_widths = c(1, 1))
```

## Fisher z-transformation
```{r Fisher z-transformation}
Z = 0.5*(log(1+R) - log(1-R))
```


## One-way ANOVA across groups
Null hypothesis is AD = SD = HC.
```{r One-way ANOVA across groups}
Fvals = array(0, dim=c(N_ROIS[1], N_ROIS[1]))
Pvals = array(NA, dim=c(N_ROIS[1], N_ROIS[1]))
for (i in 1:N_ROIS[1]) {
  for (j in 1:N_ROIS[1]) {
    if (i != j ) {
      y = Z[i,j,]
      result = summary(aov(y[infos$included] ~ infos$group[infos$included]))
      result = result[[1]]
      Fvals[i,j] = result$`F value`[1]
      Pvals[i,j] = result$`Pr(>F)`[1]
    }
  }
}

# uncorrected
Fvals_01 = Fvals
Fvals_01[Pvals > 0.01] = 0

# FDR
Pvals_ = Pvals[reidx,reidx]
Pvals_[!tri] = NA
Pvals_FDR05 = array(p.adjust(Pvals_, method = "fdr"), dim=c(N_ROIS[1],N_ROIS[1]))
Fvals_FDR05 = Fvals[reidx,reidx]
Fvals_FDR05[Pvals_FDR05 > 0.05 | is.na(Pvals_FDR05)] = 0
```

## Plot: Difference between groups
```{r Plot: Difference between groups, fig.height=2.3, fig.width=9}
limF = c(0, 12)

p1 = ggplot(melt(Fvals[reidx,reidx]*tri), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60") +
  scale_fill_gradient2(low  = "blue", mid  = "white", high = "blue",
                       midpoint = 0, limit = limF, space = "Lab", name = "F") +
  theme(axis.ticks = element_blank(), axis.line = element_blank(),
        text = element_text(size=12), plot.title = element_text(size=12),
        axis.text.x = element_text(size=12,angle=0),
        axis.text.y = element_text(size=12)) + 
  scale_y_reverse() + ggtitle("F values")

p2 = ggplot(melt(Fvals_01[reidx,reidx]*tri), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60") +
  scale_fill_gradient2(low  = "blue", mid  = "white", high = "blue",
                       midpoint = 0, limit = limF, space = "Lab", name = "F") +
  theme(axis.ticks = element_blank(), axis.line = element_blank(),
        text = element_text(size=12), plot.title = element_text(size=12),
        axis.text.x = element_text(size=12,angle=0),
        axis.text.y = element_text(size=12)) + 
  scale_y_reverse() + ggtitle("p < .01 uncor.")

p3 = ggplot(melt(Fvals_FDR05), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60") +
  scale_fill_gradient2(low  = "blue", mid  = "white", high = "blue",
                       midpoint = 0, limit = limF, space = "Lab", name = "F") +
  theme(axis.ticks = element_blank(), axis.line = element_blank(),
        text = element_text(size=12), plot.title = element_text(size=12),
        axis.text.x = element_text(size=12,angle=0),
        axis.text.y = element_text(size=12)) + 
  scale_y_reverse() + ggtitle("FDR .05")

plot_grid(p1, p2, p3, ncol = 3, nrow = 1, rel_widths = c(1, 1))

```
## Significant edges from ANOVA
```{r Significant edges from ANOVA}
idx = which(t(Fvals_FDR05) > 0, arr.ind = T)
cbind(as.character(rois$AAL_Name[match(idx[,1], rois$position)]),
      as.character(rois$AAL_Name[match(idx[,2], rois$position)]))
```

## t-test SD vs HC and AD vs HC
```{r t-test SD vs HC and AD vs HC}
HCvsSD=list()
HCvsAD=list()

HCvsSD$Tvals = array(0, dim=c(N_ROIS[1], N_ROIS[1]))
HCvsSD$Pvals = array(NA, dim=c(N_ROIS[1], N_ROIS[1]))

HCvsAD$Tvals = array(0, dim=c(N_ROIS[1], N_ROIS[1]))
HCvsAD$Pvals = array(NA, dim=c(N_ROIS[1], N_ROIS[1]))

for (i in 1:N_ROIS[1]) {
  for (j in 1:N_ROIS[1]) {
    if (i != j ) {
      
      y = Z[i,j,]
      
      idx = (infos$isSD | infos$isHC) & infos$included
      result = t.test(y[idx] ~ infos$group[idx], var.equal=T,
                      alternative = "greater")
      HCvsSD$Tvals[i,j] = result[[1]]
      HCvsSD$Pvals[i,j] = result[[3]]
      
      idx = (infos$isAD | infos$isHC) & infos$included
      result = t.test(y[idx] ~ infos$group[idx], var.equal=T,
                      alternative = "less")
      HCvsAD$Tvals[i,j] = -result[[1]]
      HCvsAD$Pvals[i,j] = result[[3]]
    }
  }
}

# FDR correction
a = HCvsSD$Pvals[reidx,reidx]
b = HCvsAD$Pvals[reidx,reidx]
a[!tri] = NA
b[!tri] = NA

M = array(p.adjust(rbind(a,b), method = "fdr"), dim=c(2*N_ROIS[1], N_ROIS[1]))
HCvsSD$Pvals_FDR05 = M[1:14,]
HCvsAD$Pvals_FDR05 = M[15:28,]

HCvsSD$Tvals_FDR05 = HCvsSD$Tvals[reidx,reidx]
HCvsAD$Tvals_FDR05 = HCvsAD$Tvals[reidx,reidx]

HCvsSD$Tvals_FDR05[HCvsSD$Pvals_FDR05 > 0.05 | is.na(HCvsSD$Pvals_FDR05)] = 0
HCvsAD$Tvals_FDR05[HCvsAD$Pvals_FDR05 > 0.05 | is.na(HCvsAD$Pvals_FDR05)] = 0
```

## Plot: t-Test
```{r Plot: t-Test, fig.height=4.5, fig.width=6}
limF = c(-3, 5)

p1 = ggplot(melt(HCvsSD$Tvals[reidx,reidx]*tri), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60") +
  scale_fill_gradient2(low  = "blue", mid  = "white", high = "red",
                       midpoint = 0, limit = limF, space = "Lab", name = "t") +
  theme(axis.ticks = element_blank(), axis.line = element_blank(),
        text = element_text(size=12), plot.title = element_text(size=12),
        axis.text.x = element_text(size=12, angle=0),
        axis.text.y = element_text(size=12)) + 
  scale_y_reverse() + ggtitle("HC > SD")

p2 = ggplot(melt(HCvsAD$Tvals[reidx,reidx]*tri), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60") +
  scale_fill_gradient2(low  = "blue", mid  = "white", high = "red",
                       midpoint = 0, limit = limF, space = "Lab", name = "t") +
  theme(axis.ticks = element_blank(), axis.line = element_blank(),
        text = element_text(size=12), plot.title = element_text(size=12),
        axis.text.x = element_text(size=12, angle=0),
        axis.text.y = element_text(size=12)) + 
  scale_y_reverse() + ggtitle("HC > AD")

p3 = ggplot(melt(HCvsSD$Tvals_FDR05), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60") +
  scale_fill_gradient2(low  = "blue", mid  = "white", high = "red",
                       midpoint = 0, limit = limF, space = "Lab", name = "t") +
  theme(axis.ticks = element_blank(), axis.line = element_blank(),
        text = element_text(size=12), plot.title = element_text(size=12),
        axis.text.x = element_text(size=12, angle=0),
        axis.text.y = element_text(size=12)) + 
  scale_y_reverse() + ggtitle("HC > SD (FDR 0.05)")

p4 = ggplot(melt(HCvsAD$Tvals_FDR05), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60") +
  scale_fill_gradient2(low  = "blue", mid  = "white", high = "red",
                       midpoint = 0, limit = limF, space = "Lab", name = "t") +
  theme(axis.ticks = element_blank(), axis.line = element_blank(),
        text = element_text(size=12), plot.title = element_text(size=12),
        axis.text.x = element_text(size=12, angle=0),
        axis.text.y = element_text(size=12)) + 
  scale_y_reverse() + ggtitle("HC > AD (FDR 0.05)")

plot_grid(p1, p2, p3, p4, ncol = 2, nrow = 2, rel_widths = c(1, 1))
```

## Significant edges from t-test
### HC > SD
```{r Significant edges from t.test}
idx = which(t(HCvsSD$Tvals_FDR05) > 0, arr.ind = T)
cbind(as.character(rois$AAL_Name[match(idx[,1], rois$position)]),
      as.character(rois$AAL_Name[match(idx[,2], rois$position)]))
```

### HC > AD
```{r Significant edges from t.test cont}
idx = which(t(HCvsAD$Tvals_FDR05) > 0, arr.ind = T)
cbind(as.character(rois$AAL_Name[match(idx[,1], rois$position)]),
      as.character(rois$AAL_Name[match(idx[,2], rois$position)]))
```

## Example of a post-hoc test hipp L parahipp L
```{r Example of a post-hoc test hipp L parahipp L, fig.height=2.3, fig.width=5}
d = data.frame(R = R[3,1,], Z = Z[3,1,], group=infos$group)
d = subset(d, infos$included)

p1 = ggplot(d, aes(x=group, y=R)) + geom_violin() + geom_boxplot(width=0.2) +
  geom_point(shape=1, color="gray70", size=4, position = position_jitter(width = 0.2, height = 0.0002)) + 
  ggtitle("Pearson's R")

p2 = ggplot(d, aes(x=group, y=Z)) + geom_violin() + geom_boxplot(width=0.2) +
  geom_point(shape=1, color="gray70", size=4, position = position_jitter(width = 0.2, height = 0.0002)) + 
  ggtitle("Fisher's Z")

plot_grid(p1, p2, ncol = 2, nrow = 1, rel_widths = c(1, 1))

summary(aov(R ~ group, data=d))
summary(aov(Z ~ group, data=d))

```



## Load time series of 200 Rois
```{r Load time series of 200 Rois, warning=FALSE}
# first stockholm sample, then china sample
f1 = list.files(path = PATH_ROIS200, pattern = "^ADSD.*.txt")
f2 = list.files(path = PATH_ROIS200, pattern = "^20.*.txt")
f = c(f1,f2)
rm(f1); rm(f2)
assert(length(f) == N)

R = array(NA, dim=c(N_ROIS[2], N_ROIS[2], N))
P = array(NA, dim=c(N_ROIS[2], N_ROIS[2], N))
R_gs = array(NA, dim=c(N_ROIS[2], N_ROIS[2], N))
P_gs = array(NA, dim=c(N_ROIS[2], N_ROIS[2], N))
for (s in 1:N) {
  d = read.table(file.path(PATH_ROIS200, f[s]), header = F)
  idx = !affected[s,][1:infos$N_vols[s]]
  d = as.matrix(d[idx,]) # excluding affected scans
  tmp =  rcorr(d, type="pearson")
  R[,,s] = tmp$r
  P[,,s] = tmp$P
  
  # global signal regression
  d_gs = array(NA, dim=dim(d))
  gs = apply(d, 1, mean, na.rm=T)
  for (r in 1:N_ROIS[2]) {
    if (sum(is.na(d[,r])) == length(gs)) {
      d_gs[,r] = rep(NA, length(gs))
    } else {
      fit = lm(d[,r] ~ gs)
      d_gs[,r] = fit$residuals
    }
  }
  
  tmp =  rcorr(d_gs, type="pearson")
  R_gs[,,s] = tmp$r
  P_gs[,,s] = tmp$P
}
# ADSD_13 has no time series from ROI 11 and ROI 12
```


## Mean correlation per group 200 ROIs
```{r Mean correlation per group 200 ROIs}
# Correlation R
reidx=1:N_ROIS[2]
tri = lower.tri(array(0, dim=c(N_ROIS[2], N_ROIS[2])))

FC200 = list()
FC200$R$SD = apply(R[,,infos$isSD & infos$included], c(1,2), mean)
FC200$R$AD = apply(R[,,infos$isAD & infos$included], c(1,2), mean, na.rm=T) # problem with ADSD_13
FC200$R$HC = apply(R[,,infos$isHC & infos$included], c(1,2), mean)

# P values
FC200$P$SD = apply(P[,,infos$isSD & infos$included], c(1,2), mean)
FC200$P$AD = apply(P[,,infos$isAD & infos$included], c(1,2), mean, na.rm=T) # problem with ADSD_13
FC200$P$HC = apply(P[,,infos$isHC & infos$included], c(1,2), mean)

# FDR 0.05
tmp = rbind(FC200$P$SD, FC200$P$AD, FC200$P$HC)
tmp[!rbind(tri,tri,tri)]=NA

# Global FDR across groups
M = array(p.adjust(tmp, method = "fdr"), dim=c(3*N_ROIS[2], N_ROIS[2]))

FC200$R_FDR05$SD = FC200$R$SD
FC200$R_FDR05$AD = FC200$R$AD
FC200$R_FDR05$HC = FC200$R$HC

FC200$P_FDR05$SD = M[1:200,]
FC200$P_FDR05$AD = M[201:400,]
FC200$P_FDR05$HC = M[401:600,]

FC200$R_FDR05$SD[FC200$P_FDR05$SD >= 0.05 | is.na(FC200$P_FDR05$AD)] = 0
FC200$R_FDR05$AD[FC200$P_FDR05$AD >= 0.05 | is.na(FC200$P_FDR05$AD)] = 0
FC200$R_FDR05$HC[FC200$P_FDR05$HC >= 0.05 | is.na(FC200$P_FDR05$HC)] = 0
```

## Plot: FC 200 ROIs
```{r Plot: FC 200 ROIs, fig.height=15, fig.width=12}
limR = c(-1, 1)
p1 = ggplot(melt(rmna(FC200$R$SD[reidx,reidx])*tri), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60") +
  scale_fill_gradient2(low  = "blue", mid  = "white", high = "red",
                       midpoint = 0, limit = limR, space = "Lab", name = "R") +
  theme(axis.ticks = element_blank(), axis.line = element_blank(),
        text = element_text(size=12), plot.title = element_text(size=12),
        axis.text.x = element_text(size=12,angle=0),
        axis.text.y = element_text(size=12)) + 
  scale_y_reverse() + ggtitle("SD")

p2 = ggplot(melt(rmna(FC200$R_FDR05$SD[reidx,reidx])*tri), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60") +
  scale_fill_gradient2(low  = "blue", mid  = "white", high = "red",
                       midpoint = 0, limit = limR, space = "Lab", name = "R") +
  theme(axis.ticks = element_blank(), axis.line = element_blank(),
        text = element_text(size=12), plot.title = element_text(size=12),
        axis.text.x = element_text(size=12,angle=0),
        axis.text.y = element_text(size=12)) + 
  scale_y_reverse() + ggtitle("FDR 0.05")

p3 = ggplot(melt(rmna(FC200$R$AD[reidx,reidx])*tri), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60") +
  scale_fill_gradient2(low  = "blue", mid  = "white", high = "red",
                       midpoint = 0, limit = limR, space = "Lab", name = "R") +
  theme(axis.ticks = element_blank(), axis.line = element_blank(),
        text = element_text(size=12), plot.title = element_text(size=12),
        axis.text.x = element_text(size=12,angle=0),
        axis.text.y = element_text(size=12)) + 
  scale_y_reverse() + ggtitle("AD")

p4 = ggplot(melt(rmna(FC200$R_FDR05$AD[reidx,reidx])*tri), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60") +
  scale_fill_gradient2(low  = "blue", mid  = "white", high = "red",
                       midpoint = 0, limit = limR, space = "Lab", name = "R") +
  theme(axis.ticks = element_blank(), axis.line = element_blank(),
        text = element_text(size=12), plot.title = element_text(size=12),
        axis.text.x = element_text(size=12,angle=0),
        axis.text.y = element_text(size=12)) + 
  scale_y_reverse() + ggtitle("FDR 0.05")

p5 = ggplot(melt(rmna(FC200$R$HC[reidx,reidx])*tri), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60") +
  scale_fill_gradient2(low  = "blue", mid  = "white", high = "red",
                       midpoint = 0, limit = limR, space = "Lab", name = "R") +
  theme(axis.ticks = element_blank(), axis.line = element_blank(),
        text = element_text(size=12), plot.title = element_text(size=12),
        axis.text.x = element_text(size=12,angle=0),
        axis.text.y = element_text(size=12)) + 
  scale_y_reverse() + ggtitle("FDR 0.05")

p6 = ggplot(melt(rmna(FC200$R_FDR05$HC[reidx,reidx])*tri), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60") +
  scale_fill_gradient2(low  = "blue", mid  = "white", high = "red",
                       midpoint = 0, limit = limR, space = "Lab", name = "R") +
  theme(axis.ticks = element_blank(), axis.line = element_blank(),
        text = element_text(size=12), plot.title = element_text(size=12),
        axis.text.x = element_text(size=12,angle=0),
        axis.text.y = element_text(size=12)) + 
  scale_y_reverse() + ggtitle("FDR 0.05")

plot_grid(p1, p2, p3, p4, p5, p6, ncol = 2, nrow = 3, rel_widths = c(1, 1))
```

## Fisher z-transformation 200 ROIS
```{r Fisher z-transformation 200 ROIS}
Z = 0.5*(log(1+R) - log(1-R))
```

## t-test temp. ROIs
```{r t-test temp ROIs}

tmpidx=as.matrix(read.table(file.path(PATH, 'Cradd_tmp_labels.txt'), header = F))
tmpidx=tmpidx[1,]
N_ROIS[3]=length(tmpidx)

HCvsSD=list()
HCvsAD=list()

HCvsSD$Tvals = array(NA, dim=c(N_ROIS[3], N_ROIS[3]))
HCvsSD$Pvals = array(NA, dim=c(N_ROIS[3], N_ROIS[3]))

HCvsAD$Tvals = array(NA, dim=c(N_ROIS[3], N_ROIS[3]))
HCvsAD$Pvals = array(NA, dim=c(N_ROIS[3], N_ROIS[3]))

for (i in 1:N_ROIS[3]) {
  for (j in 1:N_ROIS[3]) {
    if (i > j ) {
      
      y = Z[tmpidx[i],tmpidx[j],]
      idx = (infos$isSD | infos$isHC) & infos$included
      
      if (sum(is.na(y[idx]))/N > 0.33) {# ROIS missing in 1/3 of subjects
        HCvsSD$Tvals[i,j] = NA
        HCvsSD$Pvals[i,j] = NA
        HCvsAD$Tvals[i,j] = NA
        HCvsAD$Pvals[i,j] = NA
        
      } else {
        result = t.test(y[idx] ~ infos$group[idx], var.equal=T,
                        alternative = "greater")
        HCvsSD$Tvals[i,j] = result[[1]]
        HCvsSD$Pvals[i,j] = result[[3]]
        
        idx = (infos$isAD | infos$isHC) & infos$included
        result = t.test(y[idx] ~ infos$group[idx], var.equal=T,
                        alternative = "less")
        HCvsAD$Tvals[i,j] = -result[[1]]
        HCvsAD$Pvals[i,j] = result[[3]]
      }
    }
  }
}

# FDR correction
tmp = rbind(HCvsSD$Pvals, HCvsAD$Pvals)
M = array(p.adjust(tmp, method = "fdr"), dim=c(2*N_ROIS[3], N_ROIS[3]))

HCvsSD$Pvals_FDR05 = M[1:68,]
HCvsAD$Pvals_FDR05 = M[69:136,]

HCvsSD$Tvals_FDR05 = HCvsSD$Tvals
HCvsAD$Tvals_FDR05 = HCvsAD$Tvals

# sum(HCvsSD$Pvals_FDR05 < 0.05, na.rm = T)
# sum(HCvsAD$Pvals_FDR05 < 0.05, na.rm = T)

HCvsSD$Tvals_FDR05[HCvsSD$Pvals_FDR05 >= 0.05 | is.na(HCvsSD$Pvals_FDR05)] = 0
HCvsAD$Tvals_FDR05[HCvsAD$Pvals_FDR05 >= 0.05 | is.na(HCvsAD$Pvals_FDR05)] = 0

# max(rbind(HCvsSD$Tvals,HCvsAD$Tvals), na.rm=T)

```

## Plot: t-Test of temp. ROIs
```{r Plot: t-Test of temp ROIS, fig.height=12, fig.width=15}
reidx=1:N_ROIS[3]
tri = lower.tri(array(0, dim=c(N_ROIS[3], N_ROIS[3])))

mylim = c(-5.3, 5.3)

p1 = ggplot(melt(rmna(HCvsSD$Tvals[reidx,reidx])*tri), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60") +
  scale_fill_gradient2(low  = "blue", mid  = "white", high = "red",
                       midpoint = 0, limit = mylim, space = "Lab", name = "t") +
  theme(axis.ticks = element_blank(), axis.line = element_blank(),
        text = element_text(size=12), plot.title = element_text(size=12),
        axis.text.x = element_text(size=12, angle=0),
        axis.text.y = element_text(size=12)) + 
  scale_y_reverse() + ggtitle("HC > SD")

p2 = ggplot(melt(HCvsSD$Tvals_FDR05[reidx,reidx]), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60") +
  scale_fill_gradient2(low  = "blue", mid  = "white", high = "red",
                       midpoint = 0, limit = mylim, space = "Lab", name = "t") +
  theme(axis.ticks = element_blank(), axis.line = element_blank(),
        text = element_text(size=12), plot.title = element_text(size=12),
        axis.text.x = element_text(size=12, angle=0),
        axis.text.y = element_text(size=12)) + 
  scale_y_reverse() + ggtitle("HC > SD (FDR 0.05)")

p3 = ggplot(melt(rmna(HCvsAD$Tvals[reidx,reidx])*tri), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60") +
  scale_fill_gradient2(low  = "blue", mid  = "white", high = "red",
                       midpoint = 0, limit = mylim, space = "Lab", name = "t") +
  theme(axis.ticks = element_blank(), axis.line = element_blank(),
        text = element_text(size=12), plot.title = element_text(size=12),
        axis.text.x = element_text(size=12, angle=0),
        axis.text.y = element_text(size=12)) + 
  scale_y_reverse() + ggtitle("HC > AD")

p4 = ggplot(melt(HCvsAD$Tvals_FDR05[reidx,reidx]), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60") +
  scale_fill_gradient2(low  = "blue", mid  = "white", high = "red",
                       midpoint = 0, limit = mylim, space = "Lab", name = "t") +
  theme(axis.ticks = element_blank(), axis.line = element_blank(),
        text = element_text(size=12), plot.title = element_text(size=12),
        axis.text.x = element_text(size=12, angle=0),
        axis.text.y = element_text(size=12)) + 
  scale_y_reverse() + ggtitle("HC > AD (FDR 0.05)")

plot_grid(p1,p2,p3,p4, ncol = 2, nrow = 2, rel_widths = c(1, 1))
```
### HC > SD
```{r Significant edges HC vs SD}
idx = which(HCvsSD$Pvals_FDR05 < 0.05, arr.ind = T)
edges = array(tmpidx[idx], dim=c(nrow(idx),2))
print(edges)
```

### HC > AD
```{r Significant edges HC vs SD cont}
idx = which(HCvsAD$Pvals_FDR05 < 0.05, arr.ind = T)
edges = array(tmpidx[idx], dim=c(nrow(idx),2))
print(edges)
```


## Mean correlation per group 200 ROIs after global sign. reg.n
```{r Mean correlation per group 200 ROIs global sig reg}
# Correlation R
FC200gs = list()
FC200gs$R$SD = apply(R_gs[,,infos$isSD & infos$included], c(1,2), mean)
FC200gs$R$AD = apply(R_gs[,,infos$isAD & infos$included], c(1,2), mean, na.rm=T) # problem with ADSD_13
FC200gs$R$HC = apply(R_gs[,,infos$isHC & infos$included], c(1,2), mean)

# P values
FC200gs$P$SD = apply(P_gs[,,infos$isSD & infos$included], c(1,2), mean)
FC200gs$P$AD = apply(P_gs[,,infos$isAD & infos$included], c(1,2), mean, na.rm=T) # problem with ADSD_13
FC200gs$P$HC = apply(P_gs[,,infos$isHC & infos$included], c(1,2), mean)

# FDR 0.05
tmp = rbind(FC200gs$P$SD, FC200gs$P$AD, FC200gs$P$HC)
tmp[!rbind(tri,tri,tri)]=NA

# Global FDR across groups
M = array(p.adjust(tmp, method = "fdr"), dim=c(3*N_ROIS[2], N_ROIS[2]))

FC200gs$R_FDR05$SD = FC200gs$R$SD
FC200gs$R_FDR05$AD = FC200gs$R$AD
FC200gs$R_FDR05$HC = FC200gs$R$HC

FC200gs$P_FDR05$SD = M[1:200,]
FC200gs$P_FDR05$AD = M[201:400,]
FC200gs$P_FDR05$HC = M[401:600,]

FC200gs$R_FDR05$SD[FC200gs$P_FDR05$SD >= 0.05 | is.na(FC200gs$P_FDR05$AD)] = 0
FC200gs$R_FDR05$AD[FC200gs$P_FDR05$AD >= 0.05 | is.na(FC200gs$P_FDR05$AD)] = 0
FC200gs$R_FDR05$HC[FC200gs$P_FDR05$HC >= 0.05 | is.na(FC200gs$P_FDR05$HC)] = 0

reidx=1:N_ROIS[2]
tri = lower.tri(array(0, dim=c(N_ROIS[2], N_ROIS[2])))
```

## Plot: FC 200 ROIs after global sign. reg.
```{r Plot: FC 200 ROIs global sig reg, fig.height=15, fig.width=12}
limR = c(-1, 1)
p1 = ggplot(melt(rmna(FC200gs$R$SD[reidx,reidx])*tri), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60") +
  scale_fill_gradient2(low  = "blue", mid  = "white", high = "red",
                       midpoint = 0, limit = limR, space = "Lab", name = "R") +
  theme(axis.ticks = element_blank(), axis.line = element_blank(),
        text = element_text(size=12), plot.title = element_text(size=12),
        axis.text.x = element_text(size=12,angle=0),
        axis.text.y = element_text(size=12)) + 
  scale_y_reverse() + ggtitle("SD")

p2 = ggplot(melt(rmna(FC200gs$R_FDR05$SD[reidx,reidx])*tri), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60") +
  scale_fill_gradient2(low  = "blue", mid  = "white", high = "red",
                       midpoint = 0, limit = limR, space = "Lab", name = "R") +
  theme(axis.ticks = element_blank(), axis.line = element_blank(),
        text = element_text(size=12), plot.title = element_text(size=12),
        axis.text.x = element_text(size=12,angle=0),
        axis.text.y = element_text(size=12)) + 
  scale_y_reverse() + ggtitle("FDR 0.05")

p3 = ggplot(melt(rmna(FC200gs$R$AD[reidx,reidx])*tri), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60") +
  scale_fill_gradient2(low  = "blue", mid  = "white", high = "red",
                       midpoint = 0, limit = limR, space = "Lab", name = "R") +
  theme(axis.ticks = element_blank(), axis.line = element_blank(),
        text = element_text(size=12), plot.title = element_text(size=12),
        axis.text.x = element_text(size=12,angle=0),
        axis.text.y = element_text(size=12)) + 
  scale_y_reverse() + ggtitle("AD")

p4 = ggplot(melt(rmna(FC200gs$R_FDR05$AD[reidx,reidx])*tri), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60") +
  scale_fill_gradient2(low  = "blue", mid  = "white", high = "red",
                       midpoint = 0, limit = limR, space = "Lab", name = "R") +
  theme(axis.ticks = element_blank(), axis.line = element_blank(),
        text = element_text(size=12), plot.title = element_text(size=12),
        axis.text.x = element_text(size=12,angle=0),
        axis.text.y = element_text(size=12)) + 
  scale_y_reverse() + ggtitle("FDR 0.05")

p5 = ggplot(melt(rmna(FC200gs$R$HC[reidx,reidx])*tri), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60") +
  scale_fill_gradient2(low  = "blue", mid  = "white", high = "red",
                       midpoint = 0, limit = limR, space = "Lab", name = "R") +
  theme(axis.ticks = element_blank(), axis.line = element_blank(),
        text = element_text(size=12), plot.title = element_text(size=12),
        axis.text.x = element_text(size=12,angle=0),
        axis.text.y = element_text(size=12)) + 
  scale_y_reverse() + ggtitle("FDR 0.05")

p6 = ggplot(melt(rmna(FC200gs$R_FDR05$HC[reidx,reidx])*tri), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60") +
  scale_fill_gradient2(low  = "blue", mid  = "white", high = "red",
                       midpoint = 0, limit = limR, space = "Lab", name = "R") +
  theme(axis.ticks = element_blank(), axis.line = element_blank(),
        text = element_text(size=12), plot.title = element_text(size=12),
        axis.text.x = element_text(size=12,angle=0),
        axis.text.y = element_text(size=12)) + 
  scale_y_reverse() + ggtitle("FDR 0.05")

plot_grid(p1, p2, p3, p4, p5, p6, ncol = 2, nrow = 3, rel_widths = c(1, 1))
```

## Count sign. edges
```{r Count sign. edges}
l=(c("SD", "AD", "HC"))
x1 = c(sum(FC200$R_FDR05$SD*tri > 0, na.rm = T), sum(FC200$R_FDR05$AD*tri > 0),
       sum(FC200$R_FDR05$HC*tri > 0))
sprintf("%s %d %d%%", l, x1, round(x1/x1[3]*100))
x2 = c(sum(FC200gs$R_FDR05$SD*tri > 0, na.rm = T), sum(FC200gs$R_FDR05$AD*tri > 0),
       sum(FC200gs$R_FDR05$HC*tri > 0))
sprintf("%s %d %d%%", l, x2, round(x2/x2[3]*100))

```


## Fisher z-transformation 200 ROIS after global sign. reg.
```{r Fisher z-transformation 200 ROIS global sign reg}
Z = 0.5*(log(1+R_gs) - log(1-R_gs))
```

## t-test temp. ROIs after global sign. reg.
```{r t-test temp. ROIs after global sign reg}

tmpidx=as.matrix(read.table(file.path(PATH, 'Cradd_tmp_labels.txt'), header = F))
tmpidx=tmpidx[1,]
N_ROIS[3]=length(tmpidx)

HCvsSD=list()
HCvsAD=list()

HCvsSD$Tvals = array(NA, dim=c(N_ROIS[3], N_ROIS[3]))
HCvsSD$Pvals = array(NA, dim=c(N_ROIS[3], N_ROIS[3]))

HCvsAD$Tvals = array(NA, dim=c(N_ROIS[3], N_ROIS[3]))
HCvsAD$Pvals = array(NA, dim=c(N_ROIS[3], N_ROIS[3]))

for (i in 1:N_ROIS[3]) {
  for (j in 1:N_ROIS[3]) {
    if (i > j ) {
      
      y = Z[tmpidx[i],tmpidx[j],]
      idx = (infos$isSD | infos$isHC) & infos$included
      
      if (sum(is.na(y[idx]))/N > 0.33) {# ROIS missing in 1/3 of subjects
        HCvsSD$Tvals[i,j] = NA
        HCvsSD$Pvals[i,j] = NA
        HCvsAD$Tvals[i,j] = NA
        HCvsAD$Pvals[i,j] = NA
        
      } else {
        result = t.test(y[idx] ~ infos$group[idx], var.equal=T,
                        alternative = "greater")
        HCvsSD$Tvals[i,j] = result[[1]]
        HCvsSD$Pvals[i,j] = result[[3]]
        
        idx = (infos$isAD | infos$isHC) & infos$included
        result = t.test(y[idx] ~ infos$group[idx], var.equal=T,
                        alternative = "less")
        HCvsAD$Tvals[i,j] = -result[[1]]
        HCvsAD$Pvals[i,j] = result[[3]]
      }
    }
  }
}

# FDR correction
tmp = rbind(HCvsSD$Pvals, HCvsAD$Pvals)
M = array(p.adjust(tmp, method = "fdr"), dim=c(2*N_ROIS[3], N_ROIS[3]))

HCvsSD$Pvals_FDR05 = M[1:68,]
HCvsAD$Pvals_FDR05 = M[69:136,]

HCvsSD$Tvals_FDR05 = HCvsSD$Tvals
HCvsAD$Tvals_FDR05 = HCvsAD$Tvals

# sum(HCvsSD$Pvals_FDR05 < 0.05, na.rm = T)
# sum(HCvsAD$Pvals_FDR05 < 0.05, na.rm = T)

HCvsSD$Tvals_FDR05[HCvsSD$Pvals_FDR05 >= 0.05 | is.na(HCvsSD$Pvals_FDR05)] = 0
HCvsAD$Tvals_FDR05[HCvsAD$Pvals_FDR05 >= 0.05 | is.na(HCvsAD$Pvals_FDR05)] = 0

# max(rbind(HCvsSD$Tvals,HCvsAD$Tvals), na.rm=T)

```

## Plot: t-Test after global sign. reg.
```{r Plot: t-Test after global sign reg, fig.height=12, fig.width=15}
reidx=1:N_ROIS[3]
tri = lower.tri(array(0, dim=c(N_ROIS[3], N_ROIS[3])))

mylim = c(-5.2, 5.2)

p1 = ggplot(melt(rmna(HCvsSD$Tvals[reidx,reidx])*tri), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60") +
  scale_fill_gradient2(low  = "blue", mid  = "white", high = "red",
                       midpoint = 0, limit = mylim, space = "Lab", name = "t") +
  theme(axis.ticks = element_blank(), axis.line = element_blank(),
        text = element_text(size=12), plot.title = element_text(size=12),
        axis.text.x = element_text(size=12, angle=0),
        axis.text.y = element_text(size=12)) + 
  scale_y_reverse() + ggtitle("HC > SD")

p2 = ggplot(melt(HCvsSD$Tvals_FDR05[reidx,reidx]), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60") +
  scale_fill_gradient2(low  = "blue", mid  = "white", high = "red",
                       midpoint = 0, limit = mylim, space = "Lab", name = "t") +
  theme(axis.ticks = element_blank(), axis.line = element_blank(),
        text = element_text(size=12), plot.title = element_text(size=12),
        axis.text.x = element_text(size=12, angle=0),
        axis.text.y = element_text(size=12)) + 
  scale_y_reverse() + ggtitle("HC > SD (FDR 0.05)")

p3 = ggplot(melt(rmna(HCvsAD$Tvals[reidx,reidx])*tri), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60") +
  scale_fill_gradient2(low  = "blue", mid  = "white", high = "red",
                       midpoint = 0, limit = mylim, space = "Lab", name = "t") +
  theme(axis.ticks = element_blank(), axis.line = element_blank(),
        text = element_text(size=12), plot.title = element_text(size=12),
        axis.text.x = element_text(size=12, angle=0),
        axis.text.y = element_text(size=12)) + 
  scale_y_reverse() + ggtitle("HC > AD")

p4 = ggplot(melt(HCvsAD$Tvals_FDR05[reidx,reidx]), aes_string(x = "Var1", y = "Var2", fill = "value")) +
  geom_tile(color = "gray60") +
  scale_fill_gradient2(low  = "blue", mid  = "white", high = "red",
                       midpoint = 0, limit = mylim, space = "Lab", name = "t") +
  theme(axis.ticks = element_blank(), axis.line = element_blank(),
        text = element_text(size=12), plot.title = element_text(size=12),
        axis.text.x = element_text(size=12, angle=0),
        axis.text.y = element_text(size=12)) + 
  scale_y_reverse() + ggtitle("HC > AD (FDR 0.05)")

plot_grid(p1,p2,p3,p4, ncol = 2, nrow = 2, rel_widths = c(1, 1))
```

## Significant edges
### HC > SD
```{r Significant edges HC vs SD after global sign reg}
idx = which(HCvsSD$Pvals_FDR05 < 0.05, arr.ind = T)
edges = array(tmpidx[idx], dim=c(nrow(idx),2))
print(edges)
write(edges, file=file.path(PATH, 'SDedges.txt'), ncolumns = 1)
```

### HC > AD
```{r Significant edges HC vs SD cont after glob sign reg}
idx = which(HCvsAD$Pvals_FDR05 < 0.05, arr.ind = T)
edges = array(tmpidx[idx], dim=c(nrow(idx),2))
print(edges)
write(edges, file=file.path(PATH, 'ADedges.txt'), ncolumns = 1)
```